name: Publish PCM repository index

on:
  workflow_run:
    workflows: ["Release (bump version, zip, publish)"]  # adjust if your release workflow has a different name
    types: [completed]

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      # Limit how many releases we package (avoid huge downloads)
      MAX_RELEASES: "10"
      # Defaults for version templating
      STATUS: "stable"
      KICAD_VERSION: "7.0"

    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure gh-pages worktree
        run: |
          git fetch origin gh-pages || true
          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            git worktree add gh-pages gh-pages
          else
            mkdir gh-pages
            ( cd gh-pages && git init && git remote add origin "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" && git checkout -b gh-pages )
          fi

      - name: Verify templates exist
        run: |
          test -f .pcm/repository.template.json || { echo "Missing .pcm/repository.template.json"; exit 1; }
          test -f .pcm/packages.template.json || { echo "Missing .pcm/packages.template.json"; exit 1; }
          test -f .pcm/version.template.json || { echo "Missing .pcm/version.template.json"; exit 1; }

      - name: Install deps (jq, envsubst)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gettext-base

      - name: Fetch all releases (JSON)
        id: rels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Paginate through all releases
          gh api repos/${{ github.repository }}/releases --paginate > releases.json
          jq 'length' releases.json

      - name: Build versions.json array from latest releases
        id: build_versions
        env:
          STATUS: ${{ env.STATUS }}
          KICAD_VERSION: ${{ env.KICAD_VERSION }}
        run: |
          rm -f versions.json
          echo '[]' > versions.json
          # Collect the first MAX_RELEASES zip assets across releases (newest first)
          jq -r '.[] | .tag_name as $tag | .assets[] | select(.name|endswith(".zip")) | [$tag, .browser_download_url, (.size // 0)] | @tsv' releases.json \
            | head -n "${MAX_RELEASES}" > rows.tsv

          # For each asset: download zip, compute sha and install size, fill version template, append to versions.json
          while IFS=$'\t' read -r TAG URL ASIZE; do
            VER="${TAG#v}"
            echo "Processing $VER -> $URL"

            curl -L -o pkg.zip "$URL"
            SHA=$(sha256sum pkg.zip | awk '{print $1}')
            DL_SIZE=$(stat -c%s pkg.zip)   # prefer actual download size over ASIZE
            mkdir -p pkg && unzip -q pkg.zip -d pkg
            INST_SIZE=$(du -sb pkg | awk '{print $1}')
            rm -rf pkg pkg.zip

            export VERSION="$VER" DOWNLOAD_URL="$URL" DOWNLOAD_SHA256="$SHA" DOWNLOAD_SIZE="$DL_SIZE" INSTALL_SIZE="$INST_SIZE"
            export STATUS KICAD_VERSION

            # Fill one version entry and append to versions.json array
            envsubst < .pcm/version.template.json > one.json
            jq -s '.[0] + [.[1]]' versions.json one.json > tmp.json && mv tmp.json versions.json
          done < rows.tsv

          echo "Built versions.json:"
          cat versions.json

      - name: Render packages.json (inject versions array)
        env:
          SCHEMAKEY: schema
        run: |
          # First envsubst for $schema key
          envsubst < .pcm/packages.template.json > gh-pages/packages.json
          # Inject versions array
          jq --slurpfile V versions.json '.packages[0].versions = $V[0]' gh-pages/packages.json > gh-pages/packages.json.tmp
          mv gh-pages/packages.json.tmp gh-pages/packages.json
          # Validate
          jq . gh-pages/packages.json > /dev/null

      - name: Compute packages.json sha and timestamps
        id: pkgmeta
        run: |
          PKG_SHA=$(sha256sum gh-pages/packages.json | awk '{print $1}')
          TS=$(date -u +%s)
          TS_UTC=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "pkg_sha=$PKG_SHA" >> $GITHUB_OUTPUT
          echo "ts=$TS" >> $GITHUB_OUTPUT
          echo "ts_utc=$TS_UTC" >> $GITHUB_OUTPUT

      - name: Render repository.json
        env:
          SCHEMAKEY: schema
          PACKAGES_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/packages.json
          PACKAGES_SHA256: ${{ steps.pkgmeta.outputs.pkg_sha }}
          PACKAGES_UPDATE_TS: ${{ steps.pkgmeta.outputs.ts }}
          PACKAGES_UPDATE_UTC: ${{ steps.pkgmeta.outputs.ts_utc }}
        run: |
          envsubst < .pcm/repository.template.json > gh-pages/repository.json
          jq . gh-pages/repository.json > /dev/null

      - name: Commit & push repository.json + packages.json to gh-pages
        run: |
          cd gh-pages
          git add repository.json packages.json
          if ! git diff --cached --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Publish PCM index (multi-release)"
            git push origin gh-pages
          else
            echo "No changes to commit."
          fi

