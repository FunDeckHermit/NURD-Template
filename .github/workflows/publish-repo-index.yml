name: Publish PCM repository index

on:
  workflow_run:
    workflows: ["Release (bump version, zip, publish)"]
    types: [completed]

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      MAX_RELEASES: "5"
      STATUS: "testing"
      KICAD_VERSION: "7.0"

    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure gh-pages worktree
        run: |
          git fetch origin gh-pages || true
          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            git worktree add gh-pages gh-pages
          else
            mkdir gh-pages
            ( cd gh-pages && git init && git remote add origin "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" && git checkout -b gh-pages )
          fi

      - name: Verify templates and icon exist
        run: |
          test -f .pcm/repository.template.json || { echo "Missing .pcm/repository.template.json"; exit 1; }
          test -f .pcm/packages.template.json   || { echo "Missing .pcm/packages.template.json"; exit 1; }
          test -f .pcm/version.template.json    || { echo "Missing .pcm/version.template.json"; exit 1; }
          test -f resources/icon.png            || { echo "Missing /resources/icon.png"; exit 1; }

      - name: Install deps (jq, envsubst)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gettext-base

      - name: Publish icon to gh-pages
        id: icon
        run: |
          cp resources/icon.png gh-pages/icon.png
          ICON_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/icon.png"
          echo "url=$ICON_URL" >> $GITHUB_OUTPUT

      - name: Fetch all releases (JSON)
        id: rels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/releases --paginate > releases.json
          jq 'length' releases.json

      - name: Build versions.json array from latest releases
        id: build_versions
        env:
          STATUS: ${{ env.STATUS }}
          KICAD_VERSION: ${{ env.KICAD_VERSION }}
        run: |
          rm -f versions.json
          echo '[]' > versions.json
          jq -r '.[] | .tag_name as $tag | .assets[] | select(.name|endswith(".zip")) | [$tag, .browser_download_url, (.size // 0)] | @tsv' releases.json \
            | head -n "${MAX_RELEASES}" > rows.tsv

          while IFS=$'\t' read -r TAG URL ASIZE; do
            VER="${TAG#v}"
            echo "Processing $VER -> $URL"
            curl -L -o pkg.zip "$URL"
            SHA=$(sha256sum pkg.zip | awk '{print $1}')
            DL_SIZE=$(stat -c%s pkg.zip)
            mkdir -p pkg && unzip -q pkg.zip -d pkg
            INST_SIZE=$(du -sb pkg | awk '{print $1}')
            rm -rf pkg pkg.zip

            export VERSION="$VER" DOWNLOAD_URL="$URL" DOWNLOAD_SHA256="$SHA" DOWNLOAD_SIZE="$DL_SIZE" INSTALL_SIZE="$INST_SIZE"
            export STATUS KICAD_VERSION

            envsubst < .pcm/version.template.json > one.json
            jq -s '.[0] + [.[1]]' versions.json one.json > tmp.json && mv tmp.json versions.json
          done < rows.tsv

      - name: Render packages.json (inject versions + icon URL)
        env:
          SCHEMAKEY: schema
          ICON_URL: ${{ steps.icon.outputs.url }}
        run: |
          export SCHEMAKEY ICON_URL
          envsubst < .pcm/packages.template.json > gh-pages/packages.json
          jq --slurpfile V versions.json '.packages[0].versions = $V[0]' gh-pages/packages.json > gh-pages/packages.json.tmp
          mv gh-pages/packages.json.tmp gh-pages/packages.json
          jq . gh-pages/packages.json > /dev/null

      - name: Compute packages.json sha and timestamps
        id: pkgmeta
        run: |
          PKG_SHA=$(sha256sum gh-pages/packages.json | awk '{print $1}')
          TS=$(date -u +%s)
          TS_UTC=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "pkg_sha=$PKG_SHA" >> $GITHUB_OUTPUT
          echo "ts=$TS" >> $GITHUB_OUTPUT
          echo "ts_utc=$TS_UTC" >> $GITHUB_OUTPUT

      - name: Render repository.json
        env:
          SCHEMAKEY: schema
          PACKAGES_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/packages.json
          PACKAGES_SHA256: ${{ steps.pkgmeta.outputs.pkg_sha }}
          PACKAGES_UPDATE_TS: ${{ steps.pkgmeta.outputs.ts }}
          PACKAGES_UPDATE_UTC: ${{ steps.pkgmeta.outputs.ts_utc }}
        run: |
          export SCHEMAKEY PACKAGES_URL PACKAGES_SHA256 PACKAGES_UPDATE_TS PACKAGES_UPDATE_UTC
          envsubst < .pcm/repository.template.json > gh-pages/repository.json
          jq . gh-pages/repository.json > /dev/null

      - name: Commit & push repository.json, packages.json, and icon
        run: |
          cd gh-pages
          git add repository.json packages.json icon.png
          if ! git diff --cached --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Publish PCM index (multi-release) with icon"
            git push origin gh-pages
          else
            echo "No changes to commit."
          fi

